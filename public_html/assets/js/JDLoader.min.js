/* 
author: Alin     www.cgdev.net 
version: v1.0.7  
*/
THREE.JDLoader=function(r){this.manager=void 0!==r?r:THREE.DefaultLoadingManager};THREE.JDLoader.prototype={constructor:THREE.JDLoader,load:function(r,t,x,I){var L=this,J=this.texturePath&&"string"===typeof this.texturePath?this.texturePath:THREE.LoaderUtils.extractUrlBase(r);(new THREE.FileLoader(this.manager)).load(r,function(r){L.loadText(r,t,J)},x,I)},loadText:function(r,t,x){if(r=JSON.parse(r))x=this.parse(r,x),t(x)},setTexturePath:function(r){this.texturePath=r},parse:function(r,t){function x(){for(var b=[],a=0;a<K.length;++a){var c=new THREE.MeshPhongMaterial({});c.copy(K[a]);b.push(c)}return b}function I(b){var a=new THREE.Matrix4;if(!w||0>b||!w[b])return a;for(;0<=b;b=w[b].parent){var c=w[b],e=new THREE.Vector3(c.pos[0],c.pos[1],c.pos[2]),d=new THREE.Vector3(c.scl[0],c.scl[1],c.scl[2]),c=new THREE.Quaternion(c.rotq[0],c.rotq[1],c.rotq[2],c.rotq[3]),e=(new THREE.Matrix4).compose(e,c,d);a.premultiply(e)}return a}function L(b,a){if(!b)return console.error("parseOffsetAnimation: no animation"),null;var c=b.fps||30,e=!0,d=b.length||-1;"frames"==b.timeline&&(e=!1,d/=c);var h=[],g=b.name||"default",k=(b.animNodes||[])[a];if(!k)return console.error("parseOffsetAnimation: animNode "+a+" is null !"),null;var z="";void 0!==k.nodeName?z=k.nodeName:void 0!==k.nodeIndex&&(z=w[k.nodeIndex].name);for(var k={times:[],values:[]},u={times:[],values:[]},f={times:[],values:[]},l=[],p=a;0<=p;p=w[p].parent)var n=b.animNodes[p],l=M(l,n.scl.times),l=M(l,n.rot.times),l=M(l,n.pos.times);k.times=k.times.concat(l);u.times=u.times.concat(l);f.times=f.times.concat(l);var p=new THREE.Vector3,n=new THREE.Vector3,r=new THREE.Quaternion,A;new THREE.Matrix4;var y=new THREE.Matrix4;y.getInverse(I(a));for(var C=0;C<l.length;++C){A=b;var F=a,t=l[C],E=new THREE.Matrix4;if(w&&!(0>F)&&A.animNodes[F])for(var D,q,B,v,x,m;0<=F;F=w[F].parent)m=A.animNodes[F],D=J(m.scl.times,t),q=D.iBegin,B=D.iEnd,q==B?x=new THREE.Vector3(m.scl.values[3*q],m.scl.values[3*q+1],m.scl.values[3*q+2]):(D=(t-m.scl.times[q])/(m.scl.times[B]-m.scl.times[q]),x=new THREE.Vector3(m.scl.values[3*q],m.scl.values[3*q+1],m.scl.values[3*q+2]),v=new THREE.Vector3(m.scl.values[3*B],m.scl.values[3*B+1],m.scl.values[3*B+2]),x=x.lerp(v,D)),D=J(m.pos.times,t),q=D.iBegin,B=D.iEnd,q==B?v=new THREE.Vector3(m.pos.values[3*q],m.pos.values[3*q+1],m.pos.values[3*q+2]):(D=(t-m.pos.times[q])/(m.pos.times[B]-m.pos.times[q]),v=new THREE.Vector3(m.pos.values[3*q],m.pos.values[3*q+1],m.pos.values[3*q+2]),q=new THREE.Vector3(m.pos.values[3*B],m.pos.values[3*B+1],m.pos.values[3*B+2]),v=v.lerp(q,D)),D=J(m.rot.times,t),q=D.iBegin,B=D.iEnd,q==B?q=new THREE.Quaternion(m.rot.values[4*q],m.rot.values[4*q+1],m.rot.values[4*q+2],m.rot.values[4*q+3]):(D=(t-m.rot.times[q])/(m.rot.times[B]-m.rot.times[q]),q=new THREE.Quaternion(m.rot.values[4*q],m.rot.values[4*q+1],m.rot.values[4*q+2],m.rot.values[4*q+3]),m=new THREE.Quaternion(m.rot.values[4*B],m.rot.values[4*B+1],m.rot.values[4*B+2],m.rot.values[4*B+3]),q=q.slerp(m,D)),x=(new THREE.Matrix4).compose(v,q,x),E.premultiply(x);A=E;A.multiply(y);A.decompose(p,r,n);k.values.push(n.x);k.values.push(n.y);k.values.push(n.z);f.values.push(p.x);f.values.push(p.y);f.values.push(p.z);u.values.push(r.x);u.values.push(r.y);u.values.push(r.z);u.values.push(r.w)}G(e,c,THREE.VectorKeyframeTrack,z+".position",f,h);G(e,c,THREE.VectorKeyframeTrack,z+".scale",k,h);G(e,c,THREE.QuaternionKeyframeTrack,z+".quaternion",u,h);return 0===h.length?(console.error("parseOffsetAnimation: tracks.length is 0 !"),null):new THREE.AnimationClip(g,d,h)}function J(b,a){for(var c=0,e=0,d=0;d<b.length;++d)if(b[d]==a){c=e=d;break}else if(b[d]>a){c=e=d;break}else if(d==b.length-1){c=e=d;break}else if(a<b[d+1]){c=d;e=d+1;break}return{iBegin:c,iEnd:e}}function M(b,a){for(var c=[],e=0,d=0;e<b.length&&d<a.length;)b[e]<a[d]?(0!=c.length&&b[e]==c[c.length-1]||c.push(b[e]),++e):(b[e]>a[d]?0!=c.length&&a[d]==c[c.length-1]||c.push(a[d]):(0!=c.length&&c[c.length-1]==b[e]||c.push(b[e]),++e),++d);for(;e<b.length;)0!=c.length&&b[e]==c[c.length-1]||c.push(b[e]),++e;for(;d<a.length;)0!=c.length&&a[d]==c[c.length-1]||c.push(a[d]),++d;return c}function G(b,a,c,e,d,h){if(d&&Array.isArray(d.times)&&Array.isArray(d.values)){var g=[],k=[],g=g.concat(d.times),k=k.concat(d.values);if(!b)for(b=0;b<g.length;++b)g[b]/=a;g&&0!=g.length&&k&&0!=k.length&&h.push(new c(e,g,k))}}var E=0,H=this,K=[],w=[],n=[],N=[],O=[],P=[],v=[];(function(){K=[];if(void 0!==r.materials&&0!==r.materials.length){var b,a,c,e,d,h,g,k,n,u;for(u=0;u<r.materials.length;++u){var f=r.materials[u];b=new THREE.Color(16777215);a=new THREE.Color(1644825);f.diffuse&&b.fromArray(f.diffuse);f.specular&&a.fromArray(f.specular);c=void 0!==f.glossiness?f.glossiness:40;n=k=g=h=d=e=void 0;if(f.maps)for(var l=0;l<f.maps.length;++l)if(""!=f.maps[l].file)if("diffuse"==f.maps[l].type){var p=new THREE.TextureLoader;p.setCrossOrigin(H.crossOrigin);e=p.load(t+f.maps[l].file);e.wrapS=e.wrapT=THREE.RepeatWrapping}else"specular"==f.maps[l].type?(p=new THREE.TextureLoader,p.setCrossOrigin(H.crossOrigin),d=p.load(t+f.maps[l].file),d.wrapS=d.wrapT=THREE.RepeatWrapping):"bump"==f.maps[l].type?(p=new THREE.TextureLoader,p.setCrossOrigin(H.crossOrigin),h=p.load(t+f.maps[l].file),h.wrapS=h.wrapT=THREE.RepeatWrapping):"normal"==f.maps[l].type?(p=new THREE.TextureLoader,p.setCrossOrigin(H.crossOrigin),g=p.load(t+f.maps[l].file),g.wrapS=g.wrapT=THREE.RepeatWrapping):"opacity"==f.maps[l].type?(p=new THREE.TextureLoader,p.setCrossOrigin(H.crossOrigin),k=p.load(t+f.maps[l].file),k.wrapS=k.wrapT=THREE.RepeatWrapping):"lightmap"==f.maps[l].type&&(p=new THREE.TextureLoader,p.setCrossOrigin(H.crossOrigin),n=p.load(t+f.maps[l].file),n.wrapS=n.wrapT=THREE.RepeatWrapping);b=new THREE.MeshPhongMaterial({name:name,color:b.getHex(),specular:a.getHex(),shininess:c,skinning:!0});e&&(b.map=e);d&&(b.specularMap=d);h&&(b.bumpMap=h);g&&(b.normalMap=g);k&&(b.alphaMap=k,b.transparent=!0);n&&(b.lightMap=n);void 0!==f.opacity&&(b.opacity=f.opacity,1>f.opacity&&(b.transparent=!0));K.push(b)}}})();(function(){w=void 0!==r.hierarchy?r.hierarchy.nodes:r.nodes;if(Array.isArray(w)&&0<w.length)for(var b=0;b<w.length;++b)void 0!==w[b].rot&&(w[b].rotq=w[b].rot,w[b].rot=void 0);else w=[]})();(function(){var b=r.model;if(b){var a,c,e,d,h,g,k,z,u,f,l,p,t,v,A,y,C;if(b.splineShapes)for(k=0;k<b.splineShapes.length;++k){C=b.splineShapes[k];if(void 0==C)break;l=C.node;y=I(l);for(t=0;t<C.splines.length;++t){h=new THREE.BufferGeometry;h.name=C.name;1<C.splines.length&&(h.name+="_SubSpline"+t);z=new THREE.CurvePath;g=C.splines[t];for(a=0;a+2<g.points.length;a+=3)p=new THREE.Vector3(g.points[a],g.points[a+1],g.points[a+2]),p.applyMatrix4(y),g.points[a]=p.x,g.points[a+1]=p.y,g.points[a+2]=p.z;for(a=0;a+11<g.points.length;a+=9)u=new THREE.CubicBezierCurve3(new THREE.Vector3(g.points[a],g.points[a+1],g.points[a+2]),new THREE.Vector3(g.points[a+3],g.points[a+4],g.points[a+5]),new THREE.Vector3(g.points[a+6],g.points[a+7],g.points[a+8]),new THREE.Vector3(g.points[a+9],g.points[a+10],g.points[a+11])),z.add(u);h.setFromPoints(z.getPoints(C.steps+1));n.push(h);O.push("Line");P.push(C);N.push(l)}}if(b.meshes)for(C=0;C<b.meshes.length;++C){h=new THREE.BufferGeometry;k=b.meshes[C];if(void 0==k)break;k.name&&(h.name=k.name);u=k.verts;if(void 0==u)break;l=k.vertElement;if(void 0==l)break;z=k.face;t=l.vertIndices;d=l.normals;v=l.uvs;g=k.skin;l=k.node;if(void 0==l||!(0<=l&&l<w.length))break;a=w[l];if(!(a&&a.pos&&a.rotq&&a.scl))break;if(void 0==z)break;A=z.vertElementIndices;e=z.groups;if(!A||!e)break;y=I(l);z=t.length;var x=new Float32Array(3*z);for(f=0;f<z;++f)a=3*t[f],c=3*f,p=new THREE.Vector3(u[a],u[a+1],u[a+2]),p.applyMatrix4(y),x[c]=p.x,x[c+1]=p.y,x[c+2]=p.z;h.addAttribute("position",new THREE.BufferAttribute(x,3));if(void 0!==d&&0<d.length){y=(new THREE.Matrix3).getNormalMatrix(y);p=new Float32Array(d);for(a=0;a+2<d.length;a+=3)f=new THREE.Vector3(d[a],d[a+1],d[a+2]),f.applyMatrix3(y).normalize(),p[a]=f.x,p[a+1]=f.y,p[a+2]=f.z;h.addAttribute("normal",new THREE.BufferAttribute(p,3))}if(void 0!==v&&0<v.length){a:if(a=-1,e&&r.materials){for(f=0;f<e.length;++f)if((d=r.materials[e[f].materialIndex])&&d.maps)for(y=0;y<d.maps.length;++y)if("diffuse"==d.maps[y].type)if(0>a)a=d.maps[y].uvsIndex;else if(a!=d.maps[y].uvsIndex)break a;a=0>a?0:a}else a=0;a=a<v.length?a:0;f=new Float32Array(v[a]);h.addAttribute("uv",new THREE.BufferAttribute(f,2));if(1<v.length){a:{if(e&&r.materials)for(a=0;a<e.length;++a)if((f=r.materials[e[a].materialIndex])&&f.maps)for(d=0;d<f.maps.length;++d)if("lightmap"==f.maps[d].type){a=f.maps[d].uvsIndex;break a}a=-1}0<=a&&(f=new Float32Array(v[a]),h.addAttribute("uv2",new THREE.BufferAttribute(f,2)),console.log("lightmap uv index "+a))}}a=new Uint32Array(A);h.setIndex(new THREE.BufferAttribute(a,1));h.groups=e;d=u.length/3;u=[];v=[];if(g&&g.skinBones&&g.skinWeights&&g.skinBones.length==g.skinWeights.length)for(f=0;f<d;++f){A=new THREE.Vector4(0,0,0,0);a=new THREE.Vector4(0,0,0,0);for(e=y=0;4>e;++e)e<g.skinBones[f].length?(A.setComponent(e,g.skinBones[f][e]),a.setComponent(e,g.skinWeights[f][e]),++y):(A.setComponent(e,0),a.setComponent(e,0));for(;y<g.skinWeights[f].length;)a.addScalar(.25*g.skinWeights[f][y]),++y;u.push(A);v.push(a)}if(0<u.length&&0<v.length)for(g="SkinnedMesh",h.addAttribute("skinIndex",new THREE.Float32BufferAttribute(new Float32Array(4*z),4)),h.addAttribute("skinWeight",new THREE.Float32BufferAttribute(new Float32Array(4*z),4)),f=0;f<z;++f)a=t[f],A=u[a],a=v[a],h.attributes.skinIndex.setXYZW(f,A.x,A.y,A.z,A.w),h.attributes.skinWeight.setXYZW(f,a.x,a.y,a.z,a.w);else g="Mesh";t=Number(THREE.REVISION.replace(/[^0-9]/ig,""));"SkinnedMesh"!=g||98<t||(t=getBones(k))&&0<t.length&&(h.bones=t);n.push(h);O.push(g);P.push(k);N.push(l)}}})();(function(){var b=r.animation;if(b&&b.keyframeAnimations&&0!=b.keyframeAnimations.length){var b=b.keyframeAnimations.concat(),a=[],c,e,d;for(e=0;e<b.length;++e){var h=b[e];if(h){c=h.fps||30;d=!0;var g=h.length||-1;"frames"==h.timeline&&(d=!1,g/=c);for(var k=[],t=h.name||"default",h=h.animNodes||[],u=0;u<h.length;u++){var f=h[u];if(f){var l="";void 0!==f.nodeName?l=f.nodeName:void 0!==f.nodeIndex&&(l=w[f.nodeIndex].name);G(d,c,THREE.VectorKeyframeTrack,l+".position",f.pos,k);G(d,c,THREE.VectorKeyframeTrack,l+".scale",f.scl,k);G(d,c,THREE.QuaternionKeyframeTrack,l+".quaternion",f.rot,k)}}d=0===k.length?null:new THREE.AnimationClip(t,g,k)}else console.error("parseKeyFrameAnimation: no animation"),d=null;d&&a.push(d)}if(0<a.length)for(c=0;c<n.length;++c)if(e=!1,n[c]instanceof THREE.Geometry?e=n[c].skinIndices&&0<n[c].skinIndices.length&&n[c].skinWeights&&0<n[c].skinWeights.length:n[c]instanceof THREE.BufferGeometry&&(e=n[c].attributes.skinIndex&&0<n[c].attributes.skinIndex.count&&n[c].attributes.skinWeight&&0<n[c].attributes.skinWeight.count),e)n[c].animations=a;else for(n[c].animations=[],e=0;e<b.length;++e)(d=L(b[e],N[c]))&&n[c].animations.push(d)}})();for(E=0;E<n.length;++E)n[E].computeFaceNormals(),n[E].computeBoundingSphere(),v.push({geometry:n[E],type:O[E],jd_object:P[E]});E=function(){var b=new THREE.Sphere,a,c,e=0,d=0,h=0,g=[],k=[],r=new THREE.Vector3(0,0,0),t=new THREE.Vector3(0,0,0);if(n&&n.length){for(a=0;a<n.length;++a)n[a].boundingSphere||n[a].computeBoundingSphere(),d+=n[a].boundingSphere.radius;if(0<d){for(a=0;a<n.length;++a)c=n[a],k.push(c.boundingSphere.radius),g.push(c.boundingSphere.center),t.copy(c.boundingSphere.center),t.multiplyScalar(c.boundingSphere.radius/d),r.add(t);for(a=0;a<n.length;++a)c=r.distanceTo(g[a]),c>=e&&(e=c,h=e+k[a]);b.center=r;b.radius=h}}return b}();return{nodes:w,objects:v,materials:K,jd_materials:r.materials,boundingSphere:E,createObject:function(b){if("Mesh"==v[b].type)return new THREE.Mesh(v[b].geometry,x());if("SkinnedMesh"==v[b].type){b=new THREE.SkinnedMesh(v[b].geometry,x());var a,c=[],e,d,h;for(h=0;h<w.length;h++)d=w[h],e=new THREE.Bone,e.name=d.name,e.position.fromArray(d.pos),e.quaternion.fromArray(d.rotq),e.scale.fromArray(d.scl),c.push(e);for(h=0;h<w.length;h++)d=w[h],-1!==d.parent?c[d.parent].add(c[h]):a=c[h];a&&a.updateMatrixWorld(!0);a=new THREE.Skeleton(c);b.add(a.bones[0]);b.bind(a);return b}return"Line"==v[b].type?(a=v[b].jd_object.color,a=new THREE.Color(a[0]/255,a[1]/255,a[2]/255),a=new THREE.LineBasicMaterial({color:a}),new THREE.Line(v[b].geometry,a)):null}}}};